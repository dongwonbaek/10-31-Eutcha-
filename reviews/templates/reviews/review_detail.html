{% extends 'base.html' %}
{% load django_bootstrap5 %}
{% load static %}
{% block content %}
  <div class="d-flex">
    <a class='border border-dark rounded bg-light' href="{% url 'reviews:movie_detail' review.movie.pk %}"><img style='width:120px; height:160px;' class=' rounded p-1' src="{{ review.movie.image.url }}" alt="{{ review.movie.image }}"></a>
    <div class='w-100 ms-3'>
      <h1>{{ review.title }}
      </h1>
      <div class="d-flex justify-content-between">
        <div>
          <h5 class='text-secondary'>
            {{ review.movie.title }}({{ review.movie.opening_date.year }})</h5>
          <p>작성자:
            <a href="{% url 'accounts:detail' review.user.pk %}">
              {{ review.user }}</a>
          </p>
        </div>
        <div>
          <h5>평점 :
            {{ review.grade }}/5점</h5>
          <span class='text-secondary'>{{ review.created_at }}</span>
        </div>
      </div>
    </div>
  </div>
  <p style='height:10rem;' class='my-5'>{{ review.content }}</p>
  {% if request.user.is_authenticated %}
    <div class="d-flex justify-content-center">
      <div class="d-flex align-items-center">
        {% if request.user in review.like_users.all %}
          <i id="like-btn" data-review-id="{{ review.pk }}" class="btn bi bi-suit-heart-fill text-danger fs-2 heart-button"></i>
        {% else %}
          <i id="like-btn" data-review-id="{{ review.pk }}" class="btn bi bi-suit-heart text-danger fs-2 heart-button"></i>
        {% endif %}
      </div>
    </div>
    {% if review.user == request.user %}
      <div class='d-flex justify-content-end'>
        <a class='btn btn-outline-dark' href="{% url 'reviews:review_update' review.pk %}">수정</a>
        <!-- Button trigger modal -->
        <button type="button" class="mx-2 btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#exampleModal">
          삭제
        </button>

        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">정말 삭제하시겠습니까?</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                삭제된 게시글은 복구할 수 없으며 관련된 댓글 또한 삭제됩니다.
              </div>
              <div class="modal-footer">
                <form class='mx-2' action="{% url 'reviews:review_delete' review.movie.pk review.pk %}">
                  {% csrf_token %}
                  <input class='btn btn-outline-danger ' type="submit" value='삭제'>
                </form>
                <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal">아니오</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    {% endif %}
  {% endif %}
  <form action="{% url 'reviews:comment_create' review.pk %}" method="POST">
    {% csrf_token %}
    <label sytle='font-size:0.7rem;' class='text-secondary my-2' for="content">좋아요
      <span sytle='font-size:0.7rem;' id="like-count" class="text-center me-3">{{ review.like_users.count }}</span>&nbsp;&nbsp;&nbsp;&nbsp; 댓글
      {{ comments.count }}</label>
    {% bootstrap_form comment_form %}
    <div class='d-flex justify-content-end'>
      <input class='btn btn-outline-dark btn-sm' type="submit" value='등록'>
    </div>
  </form>
  <hr>
  {% for comment in comments %}
    <div class='d-flex align-items-center'>
      <a href="{% url 'accounts:detail' comment.user.pk %}" class='my-0 text-decoration-none text-dark'>{{ comment.user }}</a>
      <span style='font-size:0.8rem;' class='text-secondary mx-2'>{{ comment.created_at }}</span>
      {% if request.user.is_authenticated %}
        <a class='text-decoration-none' href="{% url 'reviews:comment_like' comment.pk %}">
          {% if request.user in comment.like_users.all %}
            <i class="bi bi-hand-thumbs-up-fill text-dark"></i>
          {% else %}
            <i class="bi bi-hand-thumbs-up text-dark"></i>
          {% endif %}
        </a>
        <span id="comment-like-count">{{ comment.like_users.count }}</span>
      {% endif %}
      {% if comment.user == request.user %}
        <form class='mx-2' action="{% url 'reviews:comment_delete' review.pk comment.pk %}" method="POST">
          {% csrf_token %}
          <button class='btn btn-outline-danger btn-sm px-1 py-0' type='submit'>
            <i class="bi bi-x-lg"></i>
          </button>
        </form>
      {% endif %}
    </div>
    <p class='my-2'>{{ comment.content }}</p>
    <hr>
  {% endfor %}
{% endblock content %}

{% block script %}
  <script>
    const likeBtn = document.querySelector('#like-btn')
    likeBtn.addEventListener('click', function (event) {
      axios({method: 'get', url: `/reviews/review/${event.target.dataset.reviewId}/like/`}).then(response => {
        if (response.data.isLiked === true) {
          likeBtn
            .classList
            .remove('bi-suit-heart')
          likeBtn
            .classList
            .add('bi-suit-heart-fill')
        } else {
          likeBtn
            .classList
            .remove('bi-suit-heart-fill')
          likeBtn
            .classList
            .add('bi-suit-heart')
        }
        const likeCount = document.querySelector('#like-count')
        likeCount.innerText = response.data.likeCount
      })
    })
  </script>

{% endblock script %}